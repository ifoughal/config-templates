{#------------------------------------------------------------#}
{# Macro: configure IP addresses for IPv4/IPv6              #}
{#------------------------------------------------------------#}
{% macro configure_ip(iface) -%}
{%- for family in [4, 6] %}
    {%- set ips = iface.ip_addresses.filter(address__family=family) %}
    {%- if ips %}
        {%- for ip in ips %}
nmcli connection modify {{ iface.name }} ipv{{ family }}.method manual ipv{{ family }}.address {{ ip.address }}
        {%- endfor %}
    {%- else %}
nmcli connection modify {{ iface.name }} ipv{{ family }}.method disabled
    {%- endif %}
{%- endfor %}
{%- endmacro %}

{#------------------------------------------------------------#}
{# Macro: configure ethernet options (MTU, speed, duplex)    #}
{#------------------------------------------------------------#}
{% macro configure_eth_opts(iface) -%}
nmcli connection modify {{ iface.name }} 802-3-ethernet.auto-negotiate no
{%- if iface.speed %}
nmcli connection modify {{ iface.name }} 802-3-ethernet.speed {{ (iface.speed / 1000) | int }}
{%- endif %}
{%- if iface.duplex %}
nmcli connection modify {{ iface.name }} 802-3-ethernet.duplex {{ iface.duplex }}
{%- endif %}
{%- if iface.mtu %}
nmcli connection modify {{ iface.name }} 802-3-ethernet.mtu {{ iface.mtu }}
{%- endif %}
{%- if iface.mac_address or iface.mac_addresses.all().first() %}
nmcli connection modify {{ iface.name }} 802-3-ethernet.cloned-mac-address {{ iface.mac_address or iface.mac_addresses.all().first() }}
{%- endif %}
{%- endmacro %}
