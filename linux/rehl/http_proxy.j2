{%- if device.custom_field_data.get('http_proxy') != None %}
######################################################################################
{%-   set http_proxy=device.custom_field_data.get('http_proxy')  %}

http_proxy id: {{ http_proxy }}
There are {{ dcim.Site.objects.count() }} sites.

http_proxy {{ ipam['Service'].objects.get(id=http_proxy) }} 
http_proxy {{ ipam['Service'].objects.get(id=http_proxy).addresses }} 
http_proxy {{ ipam['Service'].objects.get(id=http_proxy).ports }} 

{# export http_proxy={{ http_proxy.ipaddresses.first().address }}:{{ http_proxy.ports[0] }}  #}
{# export HTTP_PROXY={{ http_proxy.ipaddresses.first().address }}:{{ http_proxy.ports[0] }}  #}
######################################################################################
{% endif %}