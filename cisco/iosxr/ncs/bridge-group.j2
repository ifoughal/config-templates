{#-      builds vpns dict #}
{%-      set ns = namespace(found=false) %}
{%-      set vpns = dict() %}
{%-      set _dummy = vpns.setdefault("evpn", {}) %}
{%-      set _dummy = vpns.setdefault("l2vpn", {}) %}
{#-      update the L2VPN dict to generate the config in l2vpn template #}
{%-      for interface in device.interfaces.all() %}
{%-          if interface.bridge != None %}
{%-              set _dummy = vpns["l2vpn"].setdefault(interface.bridge.name, {}) %}
{%-              set evi = interface.l2vpn_termination %}
{%-              if evi != None %}
{%-                  set _dummy = vpns["l2vpn"][interface.bridge.name].setdefault(evi.l2vpn.name, {
                        'evi': evi.l2vpn.identifier, 
                        'type': evi.l2vpn.type, 
                        'interfaces': [],
                        'targets': {
                            'import': evi.l2vpn.import_targets.all() | map(attribute="name") | list,
                            'export': evi.l2vpn.export_targets.all() | map(attribute="name") | list
                        }
                    })
%}      
{%-                  set _dummy = vpns["l2vpn"][interface.bridge.name][evi.l2vpn.name]['interfaces'].append(interface.name) %} 
{%-            endif %}
{%-        endif %}
{%-    endfor %}

{#-      update the EVPN dict to generate the config in l2vpn template #}
{{ vpns }}
{%-        include "cisco/iosxr/ncs/l2vpn.j2" %}